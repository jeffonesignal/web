name: Auto-Translate index.html

on:
  pull_request:
    branches:
      - main
    paths:
      - 'index.html'
    types:
      - opened
      - synchronize

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if <p> content changed
        id: check_change
        run: |
          git fetch origin main
          git diff origin/main HEAD -- index.html > /tmp/index_diff.txt
          if grep -q "^[+-].*<p>" /tmp/index_diff.txt; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.check_change.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Anthropic SDK
        if: steps.check_change.outputs.changed == 'true'
        run: npm install @anthropic-ai/sdk

      - name: Run Claude translation via API
        if: steps.check_change.outputs.changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");

          const client = new Anthropic();
          const html = fs.readFileSync("index.html", "utf8");

          async function translate() {
            const response = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 4096,
              messages: [
                {
                  role: "user",
                  content: `You are a translation agent. The index.html file contains 7 sequential <p> tags in this exact language order:
          1. English (en) â€” source of truth
          2. Simplified Chinese (cn)
          3. Korean (ko)
          4. Japanese (ja)
          5. Portuguese (pt)
          6. French (fr)
          7. Turkish (tr)

          Rules:
          - Read the English <p> tag (position 1) as the source of truth
          - Translate it into the other 6 languages
          - ONLY return the 7 translated <p> tags, one per line, in the same order
          - Do NOT include any HTML structure, explanation, or markdown fences
          - Format your response exactly like this example:

          <p>English text here</p>
          <p>Chinese translation here</p>
          <p>Korean translation here</p>
          <p>Japanese translation here</p>
          <p>Portuguese translation here</p>
          <p>French translation here</p>
          <p>Turkish translation here</p>

          Here is the current index.html:
          ${html}`
                }
              ]
            });

            const result = response.content[0].text.trim();
            fs.writeFileSync("/tmp/translations.txt", result, "utf8");
            console.log("Translation complete.");
          }

          translate().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Post translations as PR comment
        if: steps.check_change.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TRANSLATIONS=$(cat /tmp/translations.txt)

          gh pr comment ${{ github.event.pull_request.number }} --body "## ğŸŒ Translation Preview

          Claude has translated the updated \`<p>\` content. Please review and apply to \`index.html\` if correct.

          ---

          $TRANSLATIONS

          ---

          **Languages:** ğŸ‡ºğŸ‡¸ en Â· ğŸ‡¨ğŸ‡³ cn Â· ğŸ‡°ğŸ‡· ko Â· ğŸ‡¯ğŸ‡µ ja Â· ğŸ‡µğŸ‡¹ pt Â· ğŸ‡«ğŸ‡· fr Â· ğŸ‡¹ğŸ‡· tr"
