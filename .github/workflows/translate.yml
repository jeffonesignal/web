name: Auto-Translate index.html

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Translate en to cn
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");
          const { execSync } = require("child_process");

          const client = new Anthropic();

          // Read current index.html as raw text
          const html = fs.readFileSync("index.html", "utf8");

          // Extract <p id="en"> content using regex
          const enMatch = html.match(/<p\s+id=["']en["'][^>]*>([\s\S]*?)<\/p>/i);
          if (!enMatch) {
            console.log("‚ùå No <p id='en'> found.");
            fs.writeFileSync("/tmp/needs_translation", "false");
            process.exit(0);
          }
          const enContent = enMatch[1].trim();
          console.log("=== CURRENT EN ===");
          console.log(enContent);

          // Get previous en content from last commit
          let prevEnContent = "";
          try {
            const prevHtml = execSync("git show HEAD~1:index.html").toString();
            const prevMatch = prevHtml.match(/<p\s+id=["']en["'][^>]*>([\s\S]*?)<\/p>/i);
            if (prevMatch) prevEnContent = prevMatch[1].trim();
          } catch (e) {
            console.log("No previous commit, will translate.");
          }
          console.log("=== PREVIOUS EN ===");
          console.log(prevEnContent);

          // Skip if unchanged
          if (enContent === prevEnContent) {
            console.log("‚úÖ No change in en content. Skipping.");
            fs.writeFileSync("/tmp/needs_translation", "false");
            process.exit(0);
          }

          console.log("üîÑ Change detected! Translating to Chinese...");
          fs.writeFileSync("/tmp/needs_translation", "true");

          async function run() {
            const res = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: `Translate the following English text to Simplified Chinese.
Return ONLY the translated text with no explanation, no quotes, no markdown.

English:
${enContent}`
              }]
            });

            const cnContent = res.content[0].text.trim();
            console.log("=== CN TRANSLATION ===");
            console.log(cnContent);

            // Replace <p id="cn">...</p> content in the HTML
            const updated = html.replace(
              /(<p\s+id=["']cn["'][^>]*>)([\s\S]*?)(<\/p>)/i,
              `$1\n  ${cnContent}\n  $3`
            );

            if (updated === html) {
              console.log("‚ö†Ô∏è Could not find <p id='cn'> to replace. Check your index.html.");
            } else {
              console.log("‚úÖ <p id='cn'> updated.");
            }

            fs.writeFileSync("/tmp/index_translated.html", updated, "utf8");
            fs.writeFileSync("/tmp/cn_translation.txt", cnContent, "utf8");
          }

          run().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Create branch and open PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEEDS=$(cat /tmp/needs_translation)
          if [ "$NEEDS" != "true" ]; then
            echo "No translation needed, skipping PR."
            exit 0
          fi

          BRANCH="auto-translate-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH ${{ github.sha }}

          # Apply translated file after branch checkout
          cp /tmp/index_translated.html index.html

          git add index.html
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: translate en to cn"
          git push origin $BRANCH

          CN=$(cat /tmp/cn_translation.txt)

          gh pr create \
            --title "chore: auto-translate <p id='en'> to Chinese" \
            --body "## üåê Translation Preview

          **English source:**
          $(grep -oP '(?<=<p id="en">)[\s\S]*?(?=</p>)' /tmp/index_translated.html || echo '(see index.html)')

          **Chinese translation:**
          $CN

          ### Review checklist
          - [ ] Translation is accurate
          - [ ] HTML structure unchanged

          > Triggered by commit: ${{ github.sha }}" \
            --base main \
            --head $BRANCH
