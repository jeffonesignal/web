name: Auto-Translate index.html

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk node-html-parser

      - name: Check and translate via Claude API
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const { parse } = require("node-html-parser");
          const fs = require("fs");

          const client = new Anthropic();
          const html = fs.readFileSync("index.html", "utf8");
          const root = parse(html);

          // Read content of each language <p> by id
          const langs = ["en", "cn", "ko", "ja", "pt", "fr", "tr"];
          const contents = {};
          for (const lang of langs) {
            const el = root.querySelector(`p[id="${lang}"]`);
            contents[lang] = el ? el.innerHTML.trim() : null;
          }

          const enContent = contents["en"];
          if (!enContent) {
            console.log("‚ùå No <p id='en'> found. Exiting.");
            process.exit(0);
          }

          // Check which languages are out of sync with en
          const toLang = { cn: "Simplified Chinese", ko: "Korean", ja: "Japanese", pt: "Portuguese", fr: "French", tr: "Turkish" };
          const outdated = Object.keys(toLang).filter(lang => {
            // If the lang <p> is missing or still contains English text, mark as outdated
            return !contents[lang] || contents[lang] === enContent;
          });

          if (outdated.length === 0) {
            console.log("‚úÖ All translations are already up to date.");
            fs.writeFileSync("/tmp/needs_translation", "false");
            process.exit(0);
          }

          console.log(`üîÑ Translating outdated languages: ${outdated.join(", ")}`);
          fs.writeFileSync("/tmp/needs_translation", "true");

          async function translate() {
            const response = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 4096,
              messages: [
                {
                  role: "user",
                  content: `You are a translation agent. Translate the following English content into these languages: ${outdated.map(l => `${l} (${toLang[l]})`).join(", ")}.

          English source:
          ${enContent}

          Rules:
          - Return ONLY a JSON object with language codes as keys and translated text as values
          - Do not include any explanation or markdown fences
          - Example format: {"cn":"...","ko":"..."}

          Translate now:`
                }
              ]
            });

            let raw = response.content[0].text.trim();
            // Strip markdown fences if present
            raw = raw.replace(/^```json\n?/, "").replace(/\n?```$/, "").trim();
            const translations = JSON.parse(raw);

            // Apply translations back into the HTML
            let updatedHtml = html;
            for (const lang of outdated) {
              if (!translations[lang]) continue;
              // Replace content inside <p id="lang">...</p>
              const regex = new RegExp(`(<p[^>]*id=["']${lang}["'][^>]*>)([\\s\\S]*?)(<\\/p>)`, "i");
              updatedHtml = updatedHtml.replace(regex, `$1${translations[lang]}$3`);
            }

            fs.writeFileSync("index.html", updatedHtml, "utf8");
            fs.writeFileSync("/tmp/translations.json", JSON.stringify(translations, null, 2));
            console.log("‚úÖ index.html updated with translations.");
          }

          translate().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Create branch and open PR
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          NEEDS=$(cat /tmp/needs_translation)
          if [ "$NEEDS" != "true" ]; then
            echo "No translation needed, skipping PR."
            exit 0
          fi

          BRANCH="auto-translate-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --hard origin/main
          git checkout -b $BRANCH
          git add index.html
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: auto-translate p tags to cn, ko, ja, pt, tr, fr"
          git push origin $BRANCH

          TRANSLATIONS=$(cat /tmp/translations.json)

          gh pr create \
            --title "chore: auto-translate updated <p id='en'> content" \
            --body "## üåê Translation Preview

          Claude detected that \`<p id='en'>\` was updated and translated the outdated languages.

          ### Translations applied
          \`\`\`json
          $TRANSLATIONS
          \`\`\`

          ### Review checklist
          - [ ] Translations are accurate and natural
          - [ ] HTML structure is unchanged
          - [ ] Only outdated languages were updated

          **Languages:** üá∫üá∏ en ¬∑ üá®üá≥ cn ¬∑ üá∞üá∑ ko ¬∑ üáØüáµ ja ¬∑ üáµüáπ pt ¬∑ üá´üá∑ fr ¬∑ üáπüá∑ tr
          > Triggered by commit: ${{ github.sha }}" \
            --base main \
            --head $BRANCH
