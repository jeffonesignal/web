name: Auto-Translate index.html

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # needed to diff against previous commit

      - name: Check if <p> content changed in en section
        id: check_change
        run: |
          git diff HEAD~1 HEAD -- index.html > /tmp/index_diff.txt

          if grep -q "^[+-].*<p>" /tmp/index_diff.txt; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "p tags changed detected"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No p tag changes detected, skipping translation"
          fi

      - name: Create translation branch
        if: steps.check_change.outputs.changed == 'true'
        run: |
          BRANCH="auto-translate-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH=$BRANCH" >> $GITHUB_ENV
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b $BRANCH

      - name: Run Claude translation
        if: steps.check_change.outputs.changed == 'true'
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: claude-sonnet-4-6
          max_turns: 10
          prompt: |
            You are a translation automation agent. Your task is to update translations in index.html.

            ## Your Task
            1. Read the current `index.html` file
            2. Find all `<p>` elements that contain English ("en") content â€” these are the source of truth
            3. For each `<p>` element, update the translated versions for these 7 languages:
               - en (English - keep as-is, this is the source)
               - cn (Simplified Chinese)
               - ko (Korean)
               - ja (Japanese)
               - pt (Portuguese)
               - tr (Turkish)
               - fr (French)

            ## Rules
            - ONLY update `<p>` tag content â€” do not change any HTML structure, attributes, classes, IDs, or other tags
            - Preserve all existing HTML attributes exactly as they are
            - Keep the same tone and meaning as the English source
            - If a translation already matches the English source meaning, you may leave it unchanged
            - Only write changes if the translation actually needs updating based on the new English content

            ## File Structure
            The translations in index.html are 7 sequential `<p>` tags in the `<body>`, in this exact order:
            1. en (English) â€” source of truth
            2. cn (Simplified Chinese)
            3. ko (Korean)
            4. ja (Japanese)
            5. pt (Portuguese)
            6. fr (French)
            7. tr (Turkish)

            There are no data attributes or lang attributes â€” the position of each `<p>` tag determines its language.
            Replace all 7 `<p>` tags with correctly translated content based on the updated English `<p>` (position 1).
            Do not add, remove, or reorder any `<p>` tags.

            ## Output
            Write the updated content back to `index.html` only. Do NOT commit or push â€” the workflow will handle that.

      - name: Commit and push translation branch
        if: steps.check_change.outputs.changed == 'true'
        run: |
          git add index.html
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: auto-translate p tags to cn, ko, ja, pt, tr, fr"
          git push origin $BRANCH

      - name: Create Pull Request
        if: steps.check_change.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr create \
            --title "chore: auto-translate updated <p> content" \
            --body "## Auto-Translation PR

          This PR was automatically generated by Claude after detecting changes to \`<p>\` content in \`index.html\`.

          ### Languages updated
          - ðŸ‡¨ðŸ‡³ Chinese (cn)
          - ðŸ‡°ðŸ‡· Korean (ko)
          - ðŸ‡¯ðŸ‡µ Japanese (ja)
          - ðŸ‡µðŸ‡¹ Portuguese (pt)
          - ðŸ‡¹ðŸ‡· Turkish (tr)
          - ðŸ‡«ðŸ‡· French (fr)

          ### Review checklist
          - [ ] Translations are accurate and natural
          - [ ] HTML structure is unchanged
          - [ ] No unintended content was modified

          > Triggered by commit: ${{ github.sha }}" \
            --base main \
            --head $BRANCH
