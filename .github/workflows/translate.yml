name: Auto-Translate index.html

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      COMMIT_SHA: ${{ github.sha }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install @anthropic-ai/sdk

      - name: Translate and create PR
        run: |
          node << 'NODESCRIPT'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");
          const { execSync } = require("child_process");

          const client = new Anthropic();
          const html = fs.readFileSync("index.html", "utf8");

          // Extract current en content
          const enMatch = html.match(/<p\s+id=["']en["'][^>]*>([\s\S]*?)<\/p>/i);
          if (!enMatch) {
            console.log("No <p id='en'> found. Exiting.");
            process.exit(0);
          }
          const enContent = enMatch[1].trim();
          console.log("CURRENT EN:", enContent.substring(0, 100));

          // Extract previous en content
          let prevEnContent = "";
          try {
            const prevHtml = execSync("git show HEAD~1:index.html").toString();
            const prevMatch = prevHtml.match(/<p\s+id=["']en["'][^>]*>([\s\S]*?)<\/p>/i);
            if (prevMatch) prevEnContent = prevMatch[1].trim();
          } catch (e) {
            console.log("No previous commit found.");
          }
          console.log("PREVIOUS EN:", prevEnContent.substring(0, 100));

          if (enContent === prevEnContent) {
            console.log("No change in en content. Skipping.");
            process.exit(0);
          }

          console.log("Change detected! Translating...");

          async function run() {
            const res = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 2048,
              messages: [{
                role: "user",
                content: "Translate the following English text to Simplified Chinese.\nReturn ONLY the translated text, no explanation.\n\nEnglish:\n" + enContent
              }]
            });

            const cnContent = res.content[0].text.trim();
            console.log("CN TRANSLATION:", cnContent.substring(0, 100));

            const updated = html.replace(
              /(<p\s+id=["']cn["'][^>]*>)([\s\S]*?)(<\/p>)/i,
              "$1\n  " + cnContent + "\n  $3"
            );

            if (updated === html) {
              console.log("WARNING: Could not find <p id='cn'>. Check index.html.");
              process.exit(1);
            }

            fs.writeFileSync("/tmp/index_translated.html", updated, "utf8");
            fs.writeFileSync("/tmp/cn_translation.txt", cnContent, "utf8");
            console.log("Translation saved.");

            // Create branch and PR using shell commands
            const branch = "auto-translate-" + new Date().toISOString().replace(/[:.]/g, "-").substring(0, 19);
            const sha = process.env.COMMIT_SHA;

            execSync("git config user.name github-actions[bot]");
            execSync('git config user.email github-actions[bot]@users.noreply.github.com');
            execSync("git checkout -b " + branch + " " + sha);
            execSync("cp /tmp/index_translated.html index.html");
            execSync("git add index.html");

            try {
              execSync('git diff --staged --quiet');
              console.log("No changes to commit.");
              process.exit(0);
            } catch (e) {
              // diff found changes, proceed
            }

            execSync('git commit -m "chore: translate en to cn"');
            execSync("git push origin " + branch);

            const prBody = "## Translation Preview\n\nClaude translated the updated English content to Chinese.\n\n### Review checklist\n- [ ] Translation is accurate\n- [ ] HTML structure unchanged";
            fs.writeFileSync("/tmp/pr_body.md", prBody);

            execSync("gh pr create --title \"chore: auto-translate en to cn\" --body-file /tmp/pr_body.md --base main --head " + branch);
            console.log("PR created successfully.");
          }

          run().catch(e => { console.error(e); process.exit(1); });
          NODESCRIPT
