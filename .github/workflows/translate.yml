name: Auto-Translate index.html

on:
  push:
    branches:
      - main
    paths:
      - 'index.html'

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if <p> content changed
        id: check_change
        run: |
          git diff HEAD~1 HEAD -- index.html > /tmp/index_diff.txt
          if grep -q "^[+-].*<p>" /tmp/index_diff.txt; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.check_change.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Anthropic SDK
        if: steps.check_change.outputs.changed == 'true'
        run: npm install @anthropic-ai/sdk

      - name: Run Claude translation via API
        if: steps.check_change.outputs.changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");

          const client = new Anthropic();
          const html = fs.readFileSync("index.html", "utf8");

          async function translate() {
            const response = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 4096,
              messages: [
                {
                  role: "user",
                  content: `You are a translation agent. The index.html file contains 7 sequential <p> tags in this exact language order:
          1. English (en) ‚Äî source of truth
          2. Simplified Chinese (cn)
          3. Korean (ko)
          4. Japanese (ja)
          5. Portuguese (pt)
          6. French (fr)
          7. Turkish (tr)

          Rules:
          - Read the English <p> tag (position 1) as the source of truth
          - Translate it into the other 6 languages
          - ONLY return the 7 <p> tags, one per line, in the same order
          - Do NOT include any HTML structure, explanation, or markdown fences
          - Format your response exactly like this:

          <p>English text here</p>
          <p>Chinese translation here</p>
          <p>Korean translation here</p>
          <p>Japanese translation here</p>
          <p>Portuguese translation here</p>
          <p>French translation here</p>
          <p>Turkish translation here</p>

          Here is the current index.html:
          ${html}`
                }
              ]
            });

            const result = response.content[0].text.trim();
            fs.writeFileSync("/tmp/translations.txt", result, "utf8");
            console.log("Translation complete.");
          }

          translate().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Apply translations to index.html
        if: steps.check_change.outputs.changed == 'true'
        run: |
          node << 'EOF'
          const fs = require("fs");
          const translations = fs.readFileSync("/tmp/translations.txt", "utf8").trim();
          let html = fs.readFileSync("index.html", "utf8");

          const pTags = translations.split("\n").filter(l => l.trim().startsWith("<p>"));
          let count = 0;
          html = html.replace(/<p>[\s\S]*?<\/p>/g, () => pTags[count++] || "");
          fs.writeFileSync("index.html", html, "utf8");
          console.log("index.html updated with translations.");
          EOF

      - name: Create branch and open PR
        if: steps.check_change.outputs.changed == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH="auto-translate-$(date +%Y%m%d-%H%M%S)"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin main
          git reset --hard origin/main
          git checkout -b $BRANCH
          git add index.html
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: auto-translate p tags to cn, ko, ja, pt, tr, fr"
          git push origin $BRANCH

          TRANSLATIONS=$(cat /tmp/translations.txt)

          gh pr create \
            --title "chore: auto-translate updated <p> content" \
            --body "## üåê Translation Preview

          Claude has translated the updated English \`<p>\` content. Please review before merging.

          ---

          $TRANSLATIONS

          ---

          ### Review checklist
          - [ ] Translations are accurate and natural
          - [ ] HTML structure is unchanged
          - [ ] No unintended content was modified

          **Languages:** üá∫üá∏ en ¬∑ üá®üá≥ cn ¬∑ üá∞üá∑ ko ¬∑ üáØüáµ ja ¬∑ üáµüáπ pt ¬∑ üá´üá∑ fr ¬∑ üáπüá∑ tr
          > Triggered by commit: ${{ github.sha }}" \
            --base main \
            --head $BRANCH
