name: Auto-Translate index.html

on:
  pull_request:
    branches:
      - main
    paths:
      - 'index.html'
    types:
      - opened
      - synchronize

jobs:
  translate:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if <p> content changed
        id: check_change
        run: |
          git diff origin/main HEAD -- index.html > /tmp/index_diff.txt
          if grep -q "^[+-].*<p>" /tmp/index_diff.txt; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Node.js
        if: steps.check_change.outputs.changed == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Anthropic SDK
        if: steps.check_change.outputs.changed == 'true'
        run: npm install @anthropic-ai/sdk

      - name: Run Claude translation via API
        if: steps.check_change.outputs.changed == 'true'
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          node << 'EOF'
          const Anthropic = require("@anthropic-ai/sdk");
          const fs = require("fs");

          const client = new Anthropic();
          const html = fs.readFileSync("index.html", "utf8");

          async function translate() {
            const response = await client.messages.create({
              model: "claude-sonnet-4-6",
              max_tokens: 4096,
              messages: [
                {
                  role: "user",
                  content: `You are a translation agent. The index.html file contains 7 sequential <p> tags in this exact language order:
          1. English (en) — source of truth
          2. Simplified Chinese (cn)
          3. Korean (ko)
          4. Japanese (ja)
          5. Portuguese (pt)
          6. French (fr)
          7. Turkish (tr)

          Rules:
          - Read the English <p> tag (position 1) as the source of truth
          - Translate it into the other 6 languages and replace each corresponding <p> tag
          - ONLY change the text inside the <p> tags — do not modify any HTML, attributes, scripts, or structure
          - Return the COMPLETE updated index.html file and nothing else — no explanation, no markdown fences

          Here is the current index.html:
          ${html}`
                }
              ]
            });

            const updatedHtml = response.content[0].text;
            fs.writeFileSync("index.html", updatedHtml, "utf8");
            console.log("Translation complete.");
          }

          translate().catch(e => { console.error(e); process.exit(1); });
          EOF

      - name: Commit translation back to PR branch
        if: steps.check_change.outputs.changed == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add index.html
          git diff --staged --quiet && echo "No changes to commit" && exit 0
          git commit -m "chore: auto-translate p tags to cn, ko, ja, pt, tr, fr"
          git push origin HEAD:${{ github.head_ref }}
